---
description: Analyze session for workflow improvements and suggest enhancements to agents, skills, and hooks
allowed-tools: Bash, Read, Write, Grep, Glob
argument-hint: [full|quick|patterns]
---

# Reflect Workflow

Analyze the current session to identify workflow improvements.

## Mode

$ARGUMENTS

- `full` or empty: Full analysis with Gemini
- `quick`: Local analysis only (faster)
- `patterns`: Cross-session pattern analysis

## Step 1: Find Transcript

```bash
# Get project hash for this directory
PROJECT_HASH=$(echo -n "$(pwd)" | md5sum | cut -d' ' -f1)
TRANSCRIPT_DIR=~/.claude/projects/$PROJECT_HASH

# Find most recent transcript
TRANSCRIPT=$(ls -t $TRANSCRIPT_DIR/*.jsonl 2>/dev/null | head -1)
echo "Transcript: $TRANSCRIPT"
```

If no transcript found, inform user and exit.

## Step 2: Parse Session Data

Read the transcript and extract:
1. Tool calls (name, input, success/failure)
2. User messages (for corrections/friction)
3. Errors and retries

```bash
# Count tool calls and errors
cat "$TRANSCRIPT" | grep -c '"type":"tool_use"' || echo 0
cat "$TRANSCRIPT" | grep -c '"is_error":true' || echo 0
```

## Step 3: Analyze Issues

### Tool Failures
- Look for `"is_error": true` in tool results
- Note which tools failed and why
- Check for permission, path, or syntax errors

### Retry Patterns
- Detect same tool called 3+ times consecutively
- Indicates approach not working

### User Corrections
Scan user messages for friction signals:
- "no, I meant..."
- "actually..."
- "wait", "stop"
- Redirections or corrections

### Efficiency Issues
- Same file read 3+ times
- Same search pattern used repeatedly
- Long gaps between actions

## Step 4: Generate Analysis

### Quick Mode
Summarize findings locally without external calls.

### Full Mode
Use Gemini for deeper analysis:

```bash
gemini "Analyze this Claude Code session transcript for improvements.

Transcript path: $TRANSCRIPT

Look for:
1. Tool failures and their causes
2. Workflow friction (user corrections, abandoned approaches)
3. Missing capabilities that required workarounds
4. Efficiency issues (repeated operations, unnecessary steps)

For each issue found, suggest:
- A specific improvement (skill, hook, or agent enhancement)
- Priority (HIGH/MEDIUM/LOW)
- How to implement it

Output in this format:
ISSUE: <description>
CATEGORY: Tool Failure | Friction | Missing Capability | Efficiency
PRIORITY: HIGH | MEDIUM | LOW
EVIDENCE: <relevant excerpt>
SUGGESTION: <specific improvement>
IMPLEMENTATION: <how to add the improvement>"
```

### Patterns Mode
Analyze cross-session patterns:

```bash
# Read patterns database
cat .claude/reflections/.patterns.json 2>/dev/null || echo "{}"

# List recent reflections
ls -t .claude/reflections/*.md 2>/dev/null | head -10
```

Identify recurring issues across sessions.

## Step 5: Create Reflection File

Create `.claude/reflections/YYYY-MM-DD-HH-MM.md`:

```markdown
# Session Reflection - [timestamp]

## Session Summary
- **Task**: [first user message]
- **Total tool calls**: X
- **Errors encountered**: X
- **Mode**: [full/quick/patterns]

## Issues Found

### Tool Failures (X issues)
| Tool | Error | Priority |
|------|-------|----------|
| ... | ... | ... |

### Workflow Friction (X issues)
- **Type**: [description]
  - Evidence: [quote]
  - Suggestion: [improvement]

### Efficiency Concerns (X issues)
- [observation] -> [recommendation]

## Suggested Improvements

### Immediate Actions
- [ ] [actionable item]

### Skills to Create
- [ ] `skill-name`: [purpose and what it should contain]

### Hooks to Add
- [ ] `hook-name`: [trigger event and purpose]

### Agent Enhancements
- [ ] [agent]: [capability to add]

## Cross-Session Patterns
[recurring issues and trends]

---
*Generated by /reflect command*
*Review and apply changes manually*
```

## Step 6: Update Patterns Database

Update `.claude/reflections/.patterns.json` with new issues:

```json
{
  "pattern_key": {
    "count": N,
    "first_seen": "ISO timestamp",
    "last_seen": "ISO timestamp"
  }
}
```

## Step 7: Report Summary

Display to user:
- Number of issues found by category
- Top 3 suggested improvements
- Path to reflection file

Remind: "Review the reflection file at `.claude/reflections/[filename].md` and apply improvements manually."

---

## Important Notes

- This command suggests improvements only, never auto-applies
- Cross-session patterns help identify recurring issues
- High-frequency patterns (5+ occurrences) indicate systemic issues
- Review past reflections with `ls -la .claude/reflections/`
